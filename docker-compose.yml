version: '3.8'

services:
  # MongoDBæ•°æ®åº“æœåŠ¡
  mongodb:
    image: mongo:6.0
    container_name: dingtalk-reminder-mongodb
    restart: unless-stopped
    environment:
      - MONGO_INITDB_ROOT_USERNAME=${MONGO_ROOT_USER:-root}
      - MONGO_INITDB_ROOT_PASSWORD=${MONGO_ROOT_PASSWORD:-root123456}
      - MONGO_INITDB_DATABASE=${MONGO_DB:-dingtalk-scheduler}
      - TZ=Asia/Shanghai
    volumes:
      - mongodb_data:/data/db
      - ./docker/mongo-init.js:/docker-entrypoint-initdb.d/init.js:ro
    ports:
      - "27017:27017"
    command: mongod --auth
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - dingtalk-network

  # é’‰é’‰æé†’ç³»ç»Ÿä¸»æœåŠ¡
  dingtalk-reminder:
    build: .
    container_name: dingtalk-reminder-app
    restart: unless-stopped
    ports:
      - "${APP_PORT:-5001}:5001"
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - PORT=5001
      # MongoDBé…ç½®
      - MONGODB_URL=mongodb://${MONGO_USER:-admin}:${MONGO_PASSWORD:-admin123456}@mongodb:27017/${MONGO_DB:-dingtalk-scheduler}?authSource=admin
      - MONGO_HOST=mongodb
      - MONGO_PORT=27017
      - MONGO_DB=${MONGO_DB:-dingtalk-scheduler}
      - MONGO_USER=${MONGO_USER:-admin}
      - MONGO_PASSWORD=${MONGO_PASSWORD:-admin123456}
      # JWTé…ç½®
      - JWT_SECRET=${JWT_SECRET:-your_jwt_secret_change_in_production}
      - JWT_REFRESH_SECRET=${JWT_REFRESH_SECRET:-your_jwt_refresh_secret_change_in_production}
      - JWT_EXPIRY=${JWT_EXPIRY:-15m}
      - JWT_REFRESH_EXPIRY=${JWT_REFRESH_EXPIRY:-7d}
      # Redisé…ç½®ï¼ˆå¯é€‰ï¼‰
      - REDIS_ENABLED=${REDIS_ENABLED:-false}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD:-redis123456}
      - REDIS_DB=0
      - CACHE_TTL=${CACHE_TTL:-3600}
      # æ—¥å¿—é…ç½®
      - LOG_LEVEL=${LOG_LEVEL:-info}
      # ä»»åŠ¡é…ç½®
      - MAX_RETRY_COUNT=${MAX_RETRY_COUNT:-3}
      - RETRY_INTERVAL=${RETRY_INTERVAL:-60}
      # ç›‘æ§é˜ˆå€¼
      - CPU_THRESHOLD=${CPU_THRESHOLD:-80}
      - MEMORY_THRESHOLD=${MEMORY_THRESHOLD:-85}
      - DISK_THRESHOLD=${DISK_THRESHOLD:-90}
      - RESPONSE_TIME_THRESHOLD=${RESPONSE_TIME_THRESHOLD:-2000}
      - ERROR_RATE_THRESHOLD=${ERROR_RATE_THRESHOLD:-5}
      # é’‰é’‰é…ç½®ï¼ˆå¯é€‰ï¼Œç”¨äºæµ‹è¯•ï¼‰
      - DINGTALK_WEBHOOK=${DINGTALK_WEBHOOK:-}
      - DINGTALK_SECRET=${DINGTALK_SECRET:-}
    volumes:
      - ./uploads:/app/backend/uploads
      - ./logs:/app/backend/logs
      - ./backups:/app/backend/backups
    depends_on:
      mongodb:
        condition: service_healthy
      redis:
        condition: service_started
    networks:
      - dingtalk-network
    command: >
      sh -c "
        echo 'â³ ç­‰å¾…MongoDBå®Œå…¨å¯åŠ¨...' &&
        sleep 10 &&
        echo 'ğŸš€ å¯åŠ¨åº”ç”¨æœåŠ¡å™¨...' &&
        node app.js
      "

  # Redisç¼“å­˜æœåŠ¡ (å¯é€‰)
  redis:
    image: redis:7-alpine
    container_name: dingtalk-reminder-redis
    restart: unless-stopped
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD:-redis123456}
    volumes:
      - redis_data:/data
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD:-redis123456}", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
    networks:
      - dingtalk-network
    profiles:
      - with-redis

  # Nginxåå‘ä»£ç† (å¯é€‰ï¼Œç”¨äºç”Ÿäº§ç¯å¢ƒ)
  nginx:
    image: nginx:alpine
    container_name: dingtalk-reminder-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./docker/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./docker/nginx/ssl:/etc/nginx/ssl:ro
      - ./docker/nginx/logs:/var/log/nginx
    depends_on:
      - dingtalk-reminder
    networks:
      - dingtalk-network
    profiles:
      - with-nginx

volumes:
  mongodb_data:
    driver: local
  redis_data:
    driver: local

networks:
  dingtalk-network:
    driver: bridge