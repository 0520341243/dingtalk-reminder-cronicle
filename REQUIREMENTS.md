# 钉钉智能任务调度管理系统需求文档

## 1. 项目概述

### 1.1 项目背景
开发一个基于钉钉机器人推送的智能任务调度管理系统，支持复杂的调度规则、批量任务导入和任务关联功能。

### 1.2 项目目标
- 实现定时任务的自动化调度和钉钉推送
- 支持Excel批量导入任务配置
- 提供灵活的调度规则设置
- 实现任务优先级管理和关联功能


## 2. 核心功能需求

### 2.1 钉钉机器人集成

#### 2.1.1 群组管理页面
- 支持多个钉钉群组配置
- 每个群组独立配置Webhook URL
- **加签功能支持**（时间戳+签名安全验证）
- 自定义重试次数设置（默认3次）
- 错误通知开关：推送失败时是否发送错误提醒

#### 2.1.2 推送内容管理
- 支持文本、Markdown格式
- **富媒体支持**：图片、链接、超链接等
- @特定人员功能
- 消息模板配置

#### 2.1.3 错误处理机制
- 推送失败自动重试（用户可配置重试次数）
- 重试失败后可选择性向指定群组发送错误通知
- 详细的错误日志记录

### 2.2 任务批量导入功能

#### 2.2.1 Excel文件结构要求
- **多工作表支持**：一个Excel文件包含多个工作表
- **工作表内容格式**：
  - 固定两列：一列标题"时间"，一列标题"消息内容"（支持中英文标题）
  - 时间格式：用户可输入文本或时间格式，系统只提取时和分
  - 内容格式：支持富媒体内容（文本、图片链接、超链接等）
- **数据处理**：系统对Excel表格格式化后存储，确保时间格式统一

#### 2.2.2 导入处理逻辑
- 解析Excel文件，识别所有工作表
- 提取每个工作表的时间和内容数据
- 数据验证和错误提示
- 导入预览功能
- 批量创建任务映射

### 2.3 任务创建和管理

#### 2.3.1 简单任务
**功能描述：** 单个时间点+单个内容的复杂调度任务

**配置界面**：
- 任务名称输入
- 单个时间选择器（HH:MM）
- 单个任务内容输入框
- **调度规则选择器**（支持所有复杂调度规则）

**执行逻辑**：
- 根据调度规则判断是否在当天执行
- 匹配的日期在指定时间推送固定内容
- 虽然是"简单任务"，但支持复杂的日期重复规则

#### 2.3.2 复杂任务
**功能描述：** 基于工作表数据的多时间点+多内容的复杂调度任务

**配置界面**：
- 任务名称
- 工作表映射选择（选择对应的Excel工作表）
- **调度规则设置**（支持所有复杂调度规则）

**执行逻辑**：
- 任务创建时仅加载当天的提醒项（如果当天匹配调度规则）
- 每日调度器运行时，检查所有复杂任务的调度规则
- 判断设置的日期规则是否匹配当天
- 如果匹配，动态加载对应工作表中的所有时间点和内容
- 在一天内按工作表的多个时间点推送对应内容

### 2.4 调度规则引擎

#### 2.4.1 基础时间规则
- **每日**：每天执行
- **每周**：指定星期几执行
- **每月**：指定日期执行
- **每年**：指定月日执行

#### 2.4.2 特定时间规则
- **某年某月某日**：一次性执行
- **某周几**：指定星期执行

#### 2.4.3 间隔规则

##### 年间隔设置
- **独立的年间隔控制**：在月份选择器上方提供0-10年的间隔设置
- **间隔0年**：一次性任务，仅在当前年度执行一次
  - 示例：设置为0年，选择7月的每周二，则仅在今年7月的周二执行
- **间隔1年**：年度任务，每年执行
  - 示例：设置为1年，选择3月15日，则每年3月15日执行
- **间隔2+年**：多年周期任务，每N年执行一次
  - 示例：设置为3年，选择7月的周二和周四，则每3年的7月份在周二和周四执行

##### 其他间隔规则
- **间隔几月**：每N月执行一次
- **间隔几周**：每N周执行一次
- **间隔几日**：每N天执行一次

**注意事项**：
- 年间隔设置与月份、星期、日期选择器组合使用
- 间隔大于1年时，不需要设置起始日期，以选择的月份/星期/日期作为执行规则
- 年间隔为0时，仅在当前年度根据设置的月份/星期/日期规则执行一次

#### 2.4.4 复杂组合规则
- **某几个月的某几日**：指定多个月份中的多个日期执行
  - 示例：每年1月、6月、12月的1号、15号、30号执行
- **某几个月的某几个星期几**：指定月份中的特定星期执行
  - 示例：每年3月、9月的每个周一、周三执行
- **多重条件组合**：支持月份、日期、星期的复杂组合
  - 示例：每年1-3月的每个周一 + 4-6月的15号 + 7-12月的每周五
- **年间隔与复杂规则组合**：年间隔可与任意复杂规则组合
  - 示例：每2年的3月和9月的周一执行
  - 示例：每3年的第一季度的15号执行
  - 示例：间隔5年，在6-8月的每个周末执行

#### 2.4.5 高级规则配置
- **年间隔独立设置**：提供0-10年的间隔选择，位于月份选择器上方
- **月份范围选择**：支持连续月份范围（如3-5月）和离散月份（如1月、6月、12月）
- **日期范围选择**：支持月初（1-10号）、月中（11-20号）、月末（21-31号）的快速选择
- **星期组合**：支持工作日（周一至周五）、周末（周六日）的快速选择
- **季度选择**：支持按季度选择（第一季度、第二季度等）
- **智能组合**：年间隔自动与下方的月份、星期、日期选择组合，形成完整的调度规则

#### 2.4.6 规则组合和优先级
- 支持多种规则的复合设置
- 规则优先级：特定日期 > 排除日期 > 基础规则
- 排除日期功能（节假日等）
- 时间范围限制（任务生效的总体时间窗口）

### 2.5 任务生命周期管理

#### 2.5.1 定时启用/关闭
- **启用时间设置**：指定任务开始生效时间
- **关闭时间设置**：指定任务停止时间
- **状态管理**：
  - 已关闭的任务不参与每日调度检查
  - 支持手动启用/禁用
  - 任务状态历史记录

#### 2.5.2 任务状态
- **待启用**：未到启用时间
- **运行中**：正常调度执行
- **已暂停**：手动暂停
- **已关闭**：已到关闭时间或手动关闭
- **已完成**：一次性任务执行完毕

### 2.6 任务关联和优先级

#### 2.6.1 任务关联功能
**场景描述：** 临时任务覆盖常规任务

**关联设置**：
- 高优先级任务设置
- 低优先级任务选择
- 关联期限设置（如1天、3天）

**执行逻辑**：
- 关联期内：只执行高优先级任务
- 关联期外：恢复执行低优先级任务
- 支持随时关联/取消关联

#### 2.6.2 优先级管理
- **优先级等级**：高、中、低
- **冲突处理**：同时间多任务时按优先级执行
- **关联链管理**：支持多层级任务关联

## 3. 非功能性需求

### 3.1 性能要求
- 支持500+日常提醒任务
- 20个并发用户访问
- 响应时间 < 200ms
- 数据库查询优化

### 3.2 可用性要求
- 系统可用性 > 99.9%
- 自动故障恢复机制
- 数据备份和恢复策略

### 3.3 安全要求
- JWT身份认证
- 角色权限管理
- 数据加密传输
- SQL注入防护
- XSS攻击防护

### 3.4 可维护性要求
- 模块化设计
- 详细的日志记录
- 监控和告警机制
- 自动化部署支持

## 4. 系统架构设计

### 4.1 整体架构
```
┌─────────────┐     ┌─────────────┐     ┌──────────────┐
│   前端界面   │────▶│   后端API   │────▶│  PostgreSQL  │
│  Vue3+EP    │     │  Express.js │     │   数据库     │
└─────────────┘     └─────────────┘     └──────────────┘
                            │                    │
                            ▼                    ▼
                    ┌─────────────┐     ┌──────────────┐
                    │    Redis    │     │   钉钉API    │
                    │    缓存     │     │   Webhook    │
                    └─────────────┘     └──────────────┘
```

### 4.2 数据库设计

#### 核心表结构
- **users**: 用户管理表
- **groups**: 钉钉群组配置表
- **tasks**: 任务基础信息表
- **schedule_rules**: 调度规则表
- **execution_plans**: 执行计划表
- **files**: Excel文件管理表
- **worksheet_mappings**: 工作表映射表
- **task_associations**: 任务关联表
- **send_logs**: 发送日志表

### 4.3 接口设计

#### RESTful API规范
- **认证接口**: /api/auth/*
- **任务管理**: /api/tasks/*
- **群组管理**: /api/groups/*
- **文件管理**: /api/files/*
- **调度管理**: /api/schedule/*
- **监控接口**: /api/monitoring/*

## 5. 实施计划

### 5.1 开发阶段
1. **第一阶段**：基础框架搭建（已完成）
2. **第二阶段**：核心功能开发（进行中）
3. **第三阶段**：复杂调度规则实现
4. **第四阶段**：性能优化和测试
5. **第五阶段**：部署和上线

### 5.2 测试计划
- 单元测试覆盖率 > 80%
- 集成测试
- 性能压力测试
- 用户验收测试

## 6. 风险管理

### 6.1 技术风险
- 钉钉API限流问题
- 大量任务并发执行性能问题
- 复杂调度规则的准确性

### 6.2 应对措施
- 实现请求队列和限流机制
- 使用缓存和异步处理优化性能
- 完善的测试用例覆盖各种场景

## 7. 维护和支持

### 7.1 日常维护
- 日志监控和分析
- 性能指标监控
- 定期数据备份
- 安全更新

### 7.2 技术支持
- 用户手册编写
- 管理员操作指南
- API文档维护
- 故障处理流程

## 8. 版本更新记录

### v1.0.0 (当前版本)
- 基础任务调度功能
- Excel文件导入
- 钉钉消息推送
- 用户权限管理

### v2.0.0 (计划中)
- 复杂调度规则引擎
- 任务关联和优先级
- 性能优化
- 监控告警系统

## 9. 附录

### 9.1 术语定义
- **简单任务**：单时间点单内容的任务
- **复杂任务**：多时间点多内容的任务
- **调度规则**：定义任务执行时间的规则集
- **执行计划**：根据调度规则生成的具体执行时间表

### 9.2 参考文档
- 钉钉开放平台API文档
- PostgreSQL官方文档
- Vue 3官方文档
- Docker官方文档